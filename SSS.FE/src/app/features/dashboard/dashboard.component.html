<div class="dashboard-container" *ngIf="isAuthenticated()">
  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading$ | async">
    <div class="loading-spinner">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <p class="mt-2 text-muted">Đang tải dữ liệu...</p>
    </div>
  </div>

  <!-- Header Section -->
  <div class="dashboard-header">
    <div class="header-content">
      <div class="header-left">
        <h1 class="dashboard-title">
          <svg class="title-icon" width="32" height="32" fill="currentColor" viewBox="0 0 24 24">
            <path d="M3 13h8V3H3v10zm0 8h8v-6H3v6zm10 0h8V11h-8v10zm0-18v6h8V3h-8z"/>
          </svg>
          Bảng điều khiển
        </h1>
        <p class="welcome-text" *ngIf="currentUser">
          Chào mừng trở lại, <strong>{{ currentUser.fullName }}</strong>! 
          <span class="current-time">{{ attendanceStatus.today }}</span>
        </p>
      </div>
      
      <div class="header-right">
        <!-- Refresh Button -->
        <button class="btn btn-outline-primary btn-refresh" 
                (click)="refreshDashboard()" 
                [disabled]="isLoading"
                title="Làm mới dữ liệu">
          <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24" 
               [class.spinning]="isLoading">
            <path d="M17.65 6.35A7.958 7.958 0 0 0 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0 1 12 18c-3.31 0-6-2.69-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/>
          </svg>
          <span class="btn-text">Làm mới</span>
        </button>
        
        <!-- User Avatar -->
        <div class="user-avatar">
          <img 
            [src]="getEmployeePhotoUrl(currentUser?.employeeCode)" 
            [alt]="currentUser?.fullName || 'User Avatar'"
            (error)="onImageError($event)"
            loading="lazy">
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-grid">
    <div class="stat-card stat-primary">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dashboardStats.totalEmployees | number }}</div>
        <div class="stat-label">Tổng nhân viên</div>
        <div class="stat-subtitle">
          <span class="active-count">{{ dashboardStats.activeEmployees | number }}</span> đang làm việc
        </div>
      </div>
    </div>

    <div class="stat-card stat-success">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dashboardStats.totalDepartments | number }}</div>
        <div class="stat-label">Phòng ban</div>
        <div class="stat-subtitle">
          <span class="location-count">{{ dashboardStats.totalWorkLocations | number }}</span> địa điểm làm việc
        </div>
      </div>
    </div>

    <div class="stat-card stat-info">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
          <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dashboardStats.todayShifts | number }}</div>
        <div class="stat-label">Ca làm hôm nay</div>
        <div class="stat-subtitle">
          <span class="upcoming-count">{{ dashboardStats.upcomingShifts | number }}</span> ca sắp tới
        </div>
      </div>
    </div>

    <div class="stat-card stat-warning">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dashboardStats.pendingLeaveRequests | number }}</div>
        <div class="stat-label">Đơn nghỉ phép chờ duyệt</div>
        <div class="stat-subtitle">
          <span class="completed-count">{{ dashboardStats.completedShifts | number }}</span> ca đã hoàn thành
        </div>
      </div>
    </div>

    <div class="stat-card stat-purple">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ formatPercentage(dashboardStats.attendanceRate) }}</div>
        <div class="stat-label">Tỷ lệ chấm công</div>
        <div class="stat-subtitle">
          <span class="hours-count">{{ formatWorkedHours(dashboardStats.averageWorkHours) }}</span> trung bình/ngày
        </div>
      </div>
    </div>

    <div class="stat-card stat-orange">
      <div class="stat-icon">
        <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24">
          <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1.41 16.09V20h-2.67v-1.93c-1.71-.36-3.16-1.46-3.27-3.4h1.96c.1 1.05.82 1.87 2.65 1.87 1.96 0 2.4-.98 2.4-1.59 0-.83-.44-1.61-2.67-2.14-2.48-.6-4.18-1.62-4.18-3.67 0-1.72 1.39-2.84 3.11-3.21V4h2.67v1.95c1.86.45 2.79 1.86 2.85 3.39H14.3c-.05-1.11-.64-1.87-2.22-1.87-1.5 0-2.4.68-2.4 1.64 0 .53.39 1.22 2.4 1.66 2.31.49 3.69 1.33 3.69 3.14 0 1.89-1.51 3.25-3.23 3.65z"/>
        </svg>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ formatWorkedHours(dashboardStats.totalWorkHours) }}</div>
        <div class="stat-label">Tổng giờ làm việc</div>
        <div class="stat-subtitle">
          <span class="avg-hours">{{ formatWorkedHours(dashboardStats.averageWorkHours) }}</span> trung bình/ngày
        </div>
      </div>
    </div>
  </div>

  <!-- Attendance Section -->
  <div class="attendance-section" *ngIf="attendanceStatus">
    <div class="attendance-card">
      <div class="card-header">
        <h3 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 1L3 5v6c0 5.55 3.84 10.74 9 12 5.16-1.26 9-6.45 9-12V5l-9-4z"/>
          </svg>
          Trạng thái chấm công
        </h3>
        <div class="attendance-status">
          <span class="status-badge" [class]="getStatusBadgeClass(attendanceStatus.status)">
            {{ getStatusText(attendanceStatus.status) }}
          </span>
        </div>
      </div>
      
      <div class="card-body">
        <div class="attendance-info">
          <div class="info-row">
            <span class="info-label">Ngày hôm nay:</span>
            <span class="info-value">{{ attendanceStatus.today }}</span>
          </div>
          
          <div class="info-row" *ngIf="attendanceStatus.lastCheckIn">
            <span class="info-label">Vào ca gần nhất:</span>
            <span class="info-value">{{ attendanceStatus.lastCheckIn | date:'short' }}</span>
          </div>
          
          <div class="info-row" *ngIf="attendanceStatus.lastCheckOut">
            <span class="info-label">Ra ca gần nhất:</span>
            <span class="info-value">{{ attendanceStatus.lastCheckOut | date:'short' }}</span>
          </div>
          
          <div class="info-row" *ngIf="attendanceStatus.totalWorkedHours > 0">
            <span class="info-label">Số giờ làm việc:</span>
            <span class="info-value">{{ formatWorkedHours(attendanceStatus.totalWorkedHours) }}</span>
          </div>

          <div class="info-row" *ngIf="attendanceStatus.currentShift">
            <span class="info-label">Ca làm hiện tại:</span>
            <span class="info-value">
              {{ formatTime(attendanceStatus.currentShift.startTime) }} - {{ formatTime(attendanceStatus.currentShift.endTime) }}
            </span>
          </div>
        </div>
        
        <div class="attendance-actions">
          <button 
            class="btn btn-success btn-checkin" 
            (click)="checkIn()" 
            [disabled]="attendanceStatus.status === 'CHECKED_IN'">
            <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
              <path d="M10 17l5-5-5-5v3H3v4h7v3zm10-9h-3V6c0-1.1-.9-2-2-2H9c-1.1 0-2 .9-2 2v2H4c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2z"/>
            </svg>
            Vào ca
          </button>
          
          <button 
            class="btn btn-danger btn-checkout" 
            (click)="checkOut()" 
            [disabled]="attendanceStatus.status !== 'CHECKED_IN'">
            <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
              <path d="M14 7l-5 5 5 5V14h7v-4h-7V7zM20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2z"/>
            </svg>
            Ra ca
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Quick Actions Row -->
  <div class="quick-actions">
    <!-- Employee Management -->
    <div class="action-card" *ngIf="hasRole('Administrator') || hasRole('Director')">
      <div class="card-header">
        <h4 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Thêm nhân viên nhanh
        </h4>
      </div>
      <div class="card-body">
        <form [formGroup]="employeeForm" (ngSubmit)="createEmployee()" class="quick-form">
          <div class="form-group">
            <input type="text" class="form-control" 
              formControlName="employeeCode" placeholder="Mã nhân viên" required>
          </div>
          <div class="form-group">
            <input type="text" class="form-control" 
              formControlName="fullName" placeholder="Họ và tên" required>
          </div>
          <div class="form-group">
            <input type="text" class="form-control" 
              formControlName="position" placeholder="Chức vụ" required>
          </div>
          <div class="form-group">
            <input type="email" class="form-control" 
              formControlName="email" placeholder="Email" required>
          </div>
          <div class="form-group">
            <select class="form-select" formControlName="departmentId" required>
              <option value="">Chọn phòng ban</option>
              <option *ngFor="let dept of departments" [value]="dept.id">
                {{ dept.name }}
              </option>
            </select>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-primary btn-sm" 
                    [disabled]="!employeeForm.valid">
              <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
              </svg>
              Thêm nhân viên
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Work Shift Management -->
    <div class="action-card" *ngIf="hasRole('Administrator') || hasRole('Director') || hasRole('TeamLeader')">
      <div class="card-header">
        <h4 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
          </svg>
          Thêm ca làm nhanh
        </h4>
      </div>
      <div class="card-body">
        <form [formGroup]="workShiftForm" (ngSubmit)="createWorkShift()" class="quick-form">
          <div class="form-group">
            <select class="form-select" formControlName="employeeCode" required>
              <option value="">Chọn nhân viên</option>
              <option *ngFor="let emp of employees" [value]="emp.employeeCode">
                {{ emp.fullName }} ({{ emp.employeeCode }})
              </option>
            </select>
          </div>
          <div class="form-group">
            <input type="date" class="form-control" 
                   formControlName="shiftDate" required>
          </div>
          <div class="form-row">
            <div class="form-group">
              <input type="time" class="form-control" 
                     formControlName="startTime" required>
            </div>
            <div class="form-group">
              <input type="time" class="form-control" 
                     formControlName="endTime" required>
            </div>
          </div>
          <div class="form-group">
            <input type="number" class="form-control" 
                   formControlName="workLocationId" placeholder="ID địa điểm làm việc" required>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-info btn-sm" 
                    [disabled]="!workShiftForm.valid">
              <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/>
              </svg>
              Thêm ca làm
            </button>
          </div>
        </form>
      </div>
    </div>

    <!-- Leave Request -->
    <div class="action-card">
      <div class="card-header">
        <h4 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
          </svg>
          Yêu cầu nghỉ phép
        </h4>
      </div>
      <div class="card-body">
        <form [formGroup]="leaveRequestForm" (ngSubmit)="createLeaveRequest()" class="quick-form">
          <div class="form-group">
            <select class="form-select" formControlName="leaveType" required>
              <option value="ANNUAL_LEAVE">Nghỉ phép năm</option>
              <option value="SICK_LEAVE">Nghỉ ốm</option>
              <option value="MATERNITY">Nghỉ thai sản</option>
              <option value="UNPAID">Nghỉ không lương</option>
            </select>
          </div>
          <div class="form-group">
            <label class="form-label">Ngày bắt đầu</label>
            <input type="date" class="form-control" 
                   formControlName="startDate" required>
          </div>
          <div class="form-group">
            <label class="form-label">Ngày kết thúc</label>
            <input type="date" class="form-control" 
                   formControlName="endDate" required>
          </div>
          <div class="form-group">
            <textarea class="form-control" 
                      formControlName="reason" placeholder="Lý do nghỉ phép" 
                      rows="2" required></textarea>
          </div>
          <div class="form-actions">
            <button type="submit" class="btn btn-warning btn-sm" 
                    [disabled]="!leaveRequestForm.valid">
              <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
              </svg>
              Gửi yêu cầu
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Recent Data Tables -->
  <div class="data-tables">
    <!-- Recent Employees -->
    <div class="data-card">
      <div class="card-header">
        <h4 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/>
          </svg>
          Nhân viên mới
        </h4>
        <a routerLink="/employees" class="view-all-link">Xem tất cả</a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Mã</th>
                <th>Họ tên</th>
                <th>Phòng ban</th>
                <th>Trạng thái</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let employee of recentActivity.recentEmployees">
                <td><strong>{{ employee.employeeCode }}</strong></td>
                <td>{{ employee.fullName }}</td>
                <td>{{ employee.departmentName || 'Chưa có' }}</td>
                <td>
                  <span class="status-badge" 
                        [class]="employee.isActive ? 'bg-success' : 'bg-secondary'">
                    {{ employee.isActive ? 'Đang làm' : 'Nghỉ việc' }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="recentActivity.recentEmployees.length === 0">
                <td colspan="4" class="text-center text-muted">Không có nhân viên nào</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Today's Work Shifts -->
    <div class="data-card">
      <div class="card-header">
        <h4 class="card-title">
          <svg class="header-icon" width="20" height="20" fill="currentColor" viewBox="0 0 24 24">
            <path d="M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"/>
            <path d="M12.5 7H11v6l5.25 3.15.75-1.23-4.5-2.67z"/>
          </svg>
          Ca làm hôm nay
        </h4>
        <a routerLink="/work-shifts" class="view-all-link">Xem tất cả</a>
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>Nhân viên</th>
                <th>Thời gian</th>
                <th>Địa điểm</th>
                <th>Trạng thái</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let shift of recentActivity.recentShifts">
                <td><strong>{{ shift.employeeName }}</strong></td>
                <td>
                  {{ formatTime(shift.startTime) }} - {{ formatTime(shift.endTime) }}
                </td>
                <td>{{ shift.workLocationName || 'Chưa xác định' }}</td>
                <td>
                  <span class="status-badge" 
                        [class]="shift.isActive ? 'bg-primary' : 'bg-secondary'">
                    {{ shift.isActive ? 'Đang làm' : 'Đã kết thúc' }}
                  </span>
                </td>
              </tr>
              <tr *ngIf="recentActivity.recentShifts.length === 0">
                <td colspan="4" class="text-center text-muted">Không có ca làm nào hôm nay</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Not Authenticated Message -->
<div class="auth-message" *ngIf="!isAuthenticated()">
  <div class="message-content">
    <svg class="message-icon" width="64" height="64" fill="currentColor" viewBox="0 0 24 24">
      <path d="M18 8h-1V6c0-2.76-2.24-5-5-5S7 3.24 7 6v2H6c-1.1 0-2 .9-2 2v10c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V10c0-1.1-.9-2-2-2zM9 6c0-1.66 1.34-3 3-3s3 1.34 3 3v2H9V6zm9 14H6V10h12v10z"/>
    </svg>
    <h2>Không có quyền truy cập</h2>
    <p>Vui lòng đăng nhập để truy cập bảng điều khiển.</p>
    <a routerLink="/auth/login" class="btn btn-primary">
      <svg class="btn-icon" width="16" height="16" fill="currentColor" viewBox="0 0 24 24">
        <path d="M11 7L9.6 8.4l2.6 2.6H2v2h10.2l-2.6 2.6L11 17l5-5-5-5zm9 12h-8v2h8c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-8v2h8v14z"/>
      </svg>
      Đăng nhập
    </a>
  </div>
</div>
